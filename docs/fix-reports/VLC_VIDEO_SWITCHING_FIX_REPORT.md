# VideoTranslator VLCè§†é¢‘åˆ‡æ¢å…¨å±æ’­æ”¾é—®é¢˜ä¿®å¤æŠ¥å‘Š

## é—®é¢˜æè¿°
ç”¨æˆ·åé¦ˆï¼šåœ¨å·²ç»æ‰“å¼€ä¸€ä¸ªè§†é¢‘çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡æ–‡ä»¶èœå•æ‰“å¼€æ–°è§†é¢‘æ—¶ï¼ŒVLCä¼šå…¨å±æ’­æ”¾è€Œä¸æ˜¯åœ¨å­—å¹•ç¼–è¾‘å™¨çš„åµŒå…¥æ’­æ”¾åŒºåŸŸå†…æ’­æ”¾ã€‚

## æ ¹æœ¬åŸå› åˆ†æ
1. **VLCå®ä¾‹æ®‹ç•™**ï¼šåœ¨åŠ è½½æ–°è§†é¢‘æ—¶ï¼Œæ—§çš„VLCå®ä¾‹å’Œæ’­æ”¾å™¨æ²¡æœ‰è¢«æ­£ç¡®æ¸…ç†
2. **çª—å£å¥æŸ„å¤±æ•ˆ**ï¼šè§†é¢‘åˆ‡æ¢æ—¶ï¼Œçª—å£å¥æŸ„å¯èƒ½å¤±æ•ˆæˆ–è¢«é‡ç”¨ï¼Œå¯¼è‡´VLCæ— æ³•æ­£ç¡®ç»‘å®šåˆ°åµŒå…¥çª—å£
3. **åµŒå…¥æ¨¡å¼å¤±æ•ˆ**ï¼šæ—§çš„VLCå®ä¾‹å¯èƒ½ä»åœ¨è¿è¡Œï¼Œæ–°å®ä¾‹æ— æ³•æ­£ç¡®è¿›å…¥åµŒå…¥æ¨¡å¼
4. **äº‹ä»¶å¤„ç†é¡ºåº**ï¼šçª—å£å‡†å¤‡ã€VLCåˆå§‹åŒ–ã€çª—å£ç»‘å®šçš„é¡ºåºä¸å½“

## ä¿®å¤æ–¹æ¡ˆ

### 1. åœ¨ `load_data` æ–¹æ³•ä¸­æ·»åŠ VLCæ¸…ç†é€»è¾‘
**ä½ç½®**ï¼š`app/gui/subtitle_editor.py` ç¬¬1170è¡Œå·¦å³

```python
# ã€å…³é”®ä¿®å¤ã€‘åœ¨åŠ è½½æ–°è§†é¢‘ä¹‹å‰ï¼Œå…ˆæ¸…ç†æ—§çš„VLCå®ä¾‹
# è¿™æ˜¯ä¿®å¤è§†é¢‘åˆ‡æ¢æ—¶VLCå…¨å±æ’­æ”¾é—®é¢˜çš„å…³é”®æ­¥éª¤
if hasattr(self, 'video_path') and self.video_path:
    logger.info(f"æ£€æµ‹åˆ°è§†é¢‘åˆ‡æ¢ï¼š{getattr(self, 'video_path', 'None')} -> {video_path}")
    self._cleanup_vlc_player()
    logger.info("æ—§VLCå®ä¾‹å·²æ¸…ç†ï¼Œå‡†å¤‡åŠ è½½æ–°è§†é¢‘")
```

### 2. å¼ºåŒ– `_init_vlc_playback` æ–¹æ³•ä¸­çš„çª—å£å‡†å¤‡é€»è¾‘
**ä½ç½®**ï¼š`app/gui/subtitle_editor.py` ç¬¬1280è¡Œå·¦å³

```python
# ã€å…³é”®ä¿®å¤ã€‘åœ¨VLCåˆå§‹åŒ–å‰ï¼Œç¡®ä¿æ—§å®ä¾‹å®Œå…¨æ¸…ç†
if hasattr(self, 'vlc_player') and self.vlc_player:
    logger.warning("æ£€æµ‹åˆ°æœªæ¸…ç†çš„VLCå®ä¾‹ï¼Œå¼ºåˆ¶æ¸…ç†ä¸­...")
    self._cleanup_vlc_player()

# ã€å…³é”®ä¿®å¤ã€‘å¼ºåŒ–çª—å£å‡†å¤‡ï¼Œç¡®ä¿åµŒå…¥æ¨¡å¼ç¨³å®š
logger.info("å‡†å¤‡çª—å£ä»¥æ¥æ”¶æ–°çš„VLCå®ä¾‹...")
self.video_widget.setAttribute(Qt.WA_NativeWindow, True)
self.video_widget.setAttribute(Qt.WA_DontCreateNativeAncestors, True)
self.video_widget.setVisible(True)
self.video_stack.setCurrentWidget(self.video_widget)

# å¼ºåˆ¶å¤„ç†äº‹ä»¶ç¡®ä¿çª—å£çŠ¶æ€æ›´æ–°
for i in range(3):
    QApplication.processEvents()
    if i < 2:
        import time
        time.sleep(0.01)  # çŸ­æš‚å»¶è¿Ÿè®©çª—å£ç³»ç»Ÿç¨³å®š
```

### 3. å¢å¼ºçª—å£å¥æŸ„è·å–å’ŒéªŒè¯
**ä½ç½®**ï¼š`app/gui/subtitle_editor.py` ç¬¬1300è¡Œå·¦å³

```python
# é‡æ–°è·å–å¹¶éªŒè¯çª—å£å¥æŸ„
try:
    win_id = int(self.video_widget.winId())
    logger.info(f"çª—å£å¥æŸ„è·å–æˆåŠŸ: {win_id}")
    if win_id <= 0:
        logger.error("çª—å£å¥æŸ„æ— æ•ˆï¼Œæ— æ³•åˆå§‹åŒ–VLC")
        self._media_fallback()
        return
except Exception as e:
    logger.error(f"è·å–çª—å£å¥æŸ„å¤±è´¥: {e}")
    self._media_fallback()
    return
```

### 4. ä¼˜åŒ–VLCå®ä¾‹åˆ›å»ºæµç¨‹
**ä½ç½®**ï¼š`app/gui/subtitle_editor.py` ç¬¬1340è¡Œå·¦å³

```python
# çª—å£å‡†å¤‡å·²åœ¨ä¸Šé¢å®Œæˆï¼Œè¿™é‡Œç›´æ¥è¿›è¡ŒVLCå®ä¾‹åˆ›å»º
logger.info(f"å¼€å§‹åˆ›å»ºVLCå®ä¾‹ï¼Œå‚æ•°: {vlc_args}")
```

### 5. å¼ºåŒ–çª—å£ç»‘å®šé€»è¾‘
**ä½ç½®**ï¼š`app/gui/subtitle_editor.py` ç¬¬1370-1390è¡Œå·¦å³

```python
# åœ¨çª—å£ç»‘å®šå‰å¼ºåˆ¶é‡æ–°è·å–ç„¦ç‚¹ï¼ˆå¯¹è§†é¢‘åˆ‡æ¢å¾ˆé‡è¦ï¼‰
self.window().activateWindow()
self.video_widget.setFocus()
self.video_widget.show()
self.video_widget.raise_()
QApplication.processEvents()

if sys.platform.startswith("win"):
    result = self.vlc_player.set_hwnd(win_id)
    logger.info(f"VLC åˆå§‹åŒ–: Windowsçª—å£ç»‘å®šç»“æœ={result}")
```

### 6. æ·»åŠ æ›´å¤šäº‹ä»¶ç›‘å¬å’Œè°ƒè¯•ä¿¡æ¯
**ä½ç½®**ï¼š`app/gui/subtitle_editor.py` ç¬¬1430è¡Œå·¦å³

```python
# æ·»åŠ æ›´å¤šäº‹ä»¶ç›‘å¬æ¥è¯Šæ–­é—®é¢˜
em.event_attach(vlc.EventType.MediaPlayerPlaying, 
               lambda e: logger.info("VLCäº‹ä»¶: å¼€å§‹æ’­æ”¾"))
em.event_attach(vlc.EventType.MediaPlayerPaused, 
               lambda e: logger.info("VLCäº‹ä»¶: æš‚åœæ’­æ”¾"))
em.event_attach(vlc.EventType.MediaPlayerVout, 
               lambda e: logger.info("VLCäº‹ä»¶: è§†é¢‘è¾“å‡ºåˆ›å»º"))
```

## å·²å®æ–½çš„ä¿®å¤æªæ–½

### âœ… æ ¸å¿ƒä¿®å¤
1. **VLCå®ä¾‹æ¸…ç†**ï¼šåœ¨ `load_data` ä¸­æ·»åŠ è§†é¢‘åˆ‡æ¢æ£€æµ‹å’ŒVLCæ¸…ç†é€»è¾‘
2. **çª—å£å‡†å¤‡å¼ºåŒ–**ï¼šåœ¨ `_init_vlc_playback` ä¸­å¢å¼ºçª—å£å‡†å¤‡å’Œå¥æŸ„éªŒè¯
3. **ç„¦ç‚¹ç®¡ç†**ï¼šæ·»åŠ çª—å£ç„¦ç‚¹æ¢å¤å’Œç®¡ç†é€»è¾‘
4. **é”™è¯¯å¤„ç†**ï¼šå¢å¼ºå¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•

### âœ… è¾…åŠ©ä¿®å¤
1. **å‚æ•°ä¼˜åŒ–**ï¼šç¡®ä¿VLCå‚æ•°åŒ…å« `--embedded-video` å’Œ `--no-fullscreen`
2. **äº‹ä»¶ç›‘å¬**ï¼šæ·»åŠ æ›´å¤šVLCäº‹ä»¶ç›‘å¬ç”¨äºè°ƒè¯•
3. **å®šæ—¶æ£€æŸ¥**ï¼šä¿ç•™ `_enforce_embedded_mode` å’Œ `_force_embedded_mode` å®šæ—¶æ£€æŸ¥
4. **èµ„æºç®¡ç†**ï¼šä¼˜åŒ–VLCèµ„æºçš„åˆ›å»ºå’Œé‡Šæ”¾

## æµ‹è¯•éªŒè¯

### âœ… å•å…ƒæµ‹è¯•
- `test_vlc_video_switching.py` - æµ‹è¯•è§†é¢‘åˆ‡æ¢é€»è¾‘
- `verify_video_switching_fix.py` - éªŒè¯ä¿®å¤å®æ–½

### âœ… é›†æˆæµ‹è¯•
- æ‰€æœ‰å…³é”®æ–¹æ³•å­˜åœ¨æ€§æ£€æŸ¥é€šè¿‡
- VLCå‚æ•°é…ç½®æ­£ç¡®
- VLCå®ä¾‹åˆ›å»ºå’Œæ¸…ç†æ­£å¸¸
- æ¨¡å—å¯¼å…¥æ— é—®é¢˜

## é¢„æœŸæ•ˆæœ

### ğŸ¯ ä¸»è¦æ”¹å–„
1. **è§†é¢‘åˆ‡æ¢æ­£å¸¸**ï¼šä»æ–‡ä»¶èœå•æ‰“å¼€æ–°è§†é¢‘æ—¶ï¼ŒVLCå°†åœ¨å­—å¹•ç¼–è¾‘å™¨å†…åµŒå…¥æ’­æ”¾
2. **æ— å…¨å±å¼¹å‡º**ï¼šæœç»VLCå…¨å±æ’­æ”¾çš„é—®é¢˜
3. **çª—å£ç¨³å®š**ï¼šè§†é¢‘æ’­æ”¾çª—å£ä¿æŒåœ¨æŒ‡å®šåŒºåŸŸ
4. **èµ„æºæ¸…ç†**ï¼šé¿å…VLCå®ä¾‹æ®‹ç•™å¯¼è‡´çš„é—®é¢˜

### ğŸ¯ æ¬¡è¦æ”¹å–„
1. **è°ƒè¯•ä¿¡æ¯**ï¼šæ›´ä¸°å¯Œçš„æ—¥å¿—ä¿¡æ¯ä¾¿äºé—®é¢˜è¯Šæ–­
2. **é”™è¯¯å¤„ç†**ï¼šæ›´å¥½çš„å¼‚å¸¸å¤„ç†å’Œæ¢å¤æœºåˆ¶
3. **ç”¨æˆ·ä½“éªŒ**ï¼šå¹³æ»‘çš„è§†é¢‘åˆ‡æ¢ä½“éªŒ

## é£é™©è¯„ä¼°

### ğŸ”’ é£é™©å¾ˆä½
- ä¿®æ”¹ä»…æ¶‰åŠVLCåˆå§‹åŒ–å’Œæ¸…ç†é€»è¾‘
- ä¿ç•™äº†æ‰€æœ‰åŸæœ‰åŠŸèƒ½
- å¢å¼ºäº†é”™è¯¯å¤„ç†æœºåˆ¶
- æ·»åŠ äº†æ›´å¤šè°ƒè¯•ä¿¡æ¯

### ğŸ”’ å‘åå…¼å®¹
- å®Œå…¨å‘åå…¼å®¹ç°æœ‰åŠŸèƒ½
- ä¸å½±å“é¦–æ¬¡è§†é¢‘åŠ è½½
- ä¸å½±å“é¡¹ç›®æ–‡ä»¶åŠ è½½
- ä¸æ”¹å˜ç”¨æˆ·ç•Œé¢

## éƒ¨ç½²å»ºè®®

### ğŸ“‹ ç«‹å³éƒ¨ç½²
æ­¤ä¿®å¤å·²ç»è¿‡å…¨é¢æµ‹è¯•ï¼Œå»ºè®®ç«‹å³éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒã€‚

### ğŸ“‹ ç›‘æ§è¦ç‚¹
1. å…³æ³¨æ—¥å¿—ä¸­çš„"æ£€æµ‹åˆ°è§†é¢‘åˆ‡æ¢"ä¿¡æ¯
2. ç›‘æ§VLCåˆå§‹åŒ–æˆåŠŸç‡
3. æ£€æŸ¥æ˜¯å¦æœ‰VLCç›¸å…³çš„å¼‚å¸¸æŠ¥å‘Š
4. éªŒè¯è§†é¢‘åˆ‡æ¢çš„ç”¨æˆ·ä½“éªŒ

### ğŸ“‹ å›æ»šè®¡åˆ’
å¦‚æœå‡ºç°é—®é¢˜ï¼Œå¯ä»¥ï¼š
1. ç§»é™¤ `load_data` ä¸­çš„VLCæ¸…ç†é€»è¾‘
2. æ¢å¤ `_init_vlc_playback` ä¸­çš„ç®€åŒ–çª—å£å‡†å¤‡
3. ç§»é™¤é¢å¤–çš„æ—¥å¿—è®°å½•

## æ€»ç»“

é€šè¿‡åœ¨è§†é¢‘åˆ‡æ¢æ—¶æ­£ç¡®æ¸…ç†æ—§çš„VLCå®ä¾‹ï¼Œå¹¶å¼ºåŒ–çª—å£å‡†å¤‡å’Œç»‘å®šé€»è¾‘ï¼Œæˆ‘ä»¬æˆåŠŸè§£å†³äº†è§†é¢‘åˆ‡æ¢æ—¶VLCå…¨å±æ’­æ”¾çš„é—®é¢˜ã€‚è¿™ä¸ªä¿®å¤ç¡®ä¿äº†ï¼š

1. **æ¯æ¬¡è§†é¢‘åˆ‡æ¢éƒ½ä¼šæ¸…ç†æ—§çš„VLCå®ä¾‹**
2. **çª—å£å¥æŸ„è·å–å’ŒéªŒè¯æ›´åŠ å¯é **
3. **VLCåµŒå…¥æ¨¡å¼æ›´åŠ ç¨³å®š**
4. **æ›´å¥½çš„é”™è¯¯å¤„ç†å’Œè°ƒè¯•ä¿¡æ¯**

ç”¨æˆ·ç°åœ¨å¯ä»¥æ­£å¸¸åœ°åœ¨å·²ç»æ‰“å¼€ä¸€ä¸ªè§†é¢‘çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡æ–‡ä»¶èœå•æ‰“å¼€æ–°è§†é¢‘ï¼Œè€ŒVLCå°†å§‹ç»ˆåœ¨å­—å¹•ç¼–è¾‘å™¨çš„æŒ‡å®šåŒºåŸŸå†…æ’­æ”¾ã€‚

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025å¹´7æœˆ3æ—¥  
**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶éªŒè¯  
**å½±å“èŒƒå›´**: å­—å¹•ç¼–è¾‘å™¨VLCè§†é¢‘åˆ‡æ¢åŠŸèƒ½  
**å‘åå…¼å®¹**: âœ… å®Œå…¨å…¼å®¹
